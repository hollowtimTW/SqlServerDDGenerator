@page
@model IndexModel
@{
    ViewData["Title"] = "Data Dictionary Generator";
}

<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-database-fill-gear me-2"></i>
        DATA DICTIONARY GENERATOR
    </h1>

    <!-- 訊息提示區 -->
    <div id="messageBox" class="alert d-none alert-dismissible fade show" role="alert">
        <span id="messageText"></span>
        <button type="button" class="btn-close" onclick="hideMessage()"></button>
    </div>

    <!-- 連線設定 -->
    <div class="card mb-3" id="connectionCard">
        <div class="card-header">
            <h3><i class="bi bi-plug-fill me-2"></i>DATABASE CONNECTION</h3>
        </div>
        <div class="card-body" id="connectionForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label"><i class="bi bi-server me-1"></i>Server Instance</label>
                    <input type="text" class="form-control" id="serverName" placeholder="localhost / 127.0.0.1 / .\SQLEXPRESS" required />
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label"><i class="bi bi-shield-lock me-1"></i>Authentication Mode</label>
                    <select class="form-select" id="authTypeSelect" onchange="toggleAuthFields()">
                        <option value="Windows">Windows Authentication</option>
                        <option value="SA">SQL Server Authentication</option>
                    </select>
                </div>
            </div>

            <div id="sqlAuthFields" style="display: none;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-person-fill me-1"></i>Username</label>
                        <input type="text" class="form-control" id="username" placeholder="sa" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-key-fill me-1"></i>Password</label>
                        <input type="password" class="form-control" id="password" placeholder="••••••••" />
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="trustCertificate" checked>
                        <label class="form-check-label" for="trustCertificate">
                            Trust Server Certificate
                        </label>
                        <div class="form-text">Enable for self-signed certificates or dev environments</div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="rememberConnection" checked>
                    <label class="form-check-label" for="rememberConnection">
                        <i class="bi bi-bookmark-fill me-1"></i>Remember connection settings
                    </label>
                </div>
            </div>

            <button type="button" class="btn btn-primary" id="btnTestConnection" onclick="testConnection()">
                <span class="spinner-border spinner-border-sm d-none me-2" id="spinnerTest"></span>
                <i class="bi bi-link-45deg me-1"></i>
                CONNECT & LOAD DATABASES
            </button>
            <button type="button" class="btn btn-secondary ms-2" onclick="clearConnectionInfo()">
                <i class="bi bi-trash3 me-1"></i>
                CLEAR MEMORY
            </button>
        </div>
        
        <!-- 收合後的簡化顯示 -->
        <div class="card-body d-none" id="connectionSummary">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-success me-2">
                        <i class="bi bi-check-circle-fill me-1"></i>CONNECTED
                    </span>
                    <strong id="connectedServer"></strong>
                    <span class="text-muted ms-2" id="connectedAuth"></span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showConnectionForm()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    RECONFIGURE
                </button>
            </div>
        </div>
    </div>

    <!-- 選擇資料庫 -->
    <div class="card mb-3">
        <div class="card-header">
            <h3><i class="bi bi-database me-2"></i>STEP 1: SELECT DATABASE</h3>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label"><i class="bi bi-collection me-1"></i>Available Databases (Permission Filtered)</label>
                <select class="form-select" id="databaseSelect" onchange="loadTables()" disabled>
                    <option value="">-- Connect to server first --</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 選擇資料表 -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3><i class="bi bi-table me-2"></i>STEP 2: SELECT TABLES</h3>
            <div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTables()">
                    <i class="bi bi-check-all me-1"></i>SELECT ALL
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAllTables()">
                    <i class="bi bi-x-lg me-1"></i>DESELECT ALL
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="tablesContainer" class="row">
                <p class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Select a database to load tables
                </p>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-success" id="btnGenerate" onclick="generateDD()" disabled>
                    <span class="spinner-border spinner-border-sm d-none me-2" id="spinnerGenerate"></span>
                    <i class="bi bi-file-earmark-text me-1"></i>
                    GENERATE DICTIONARY
                </button>
                <button type="button" class="btn btn-secondary ms-2" onclick="resetAll()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                    RESET
                </button>
            </div>
        </div>
    </div>

    <!-- 完成 -->
    <div class="card mb-4 d-none" id="resultCard">
        <div class="card-header" style="background: var(--gradient-success); color: white;">
            <h3><i class="bi bi-check-circle-fill me-2"></i>GENERATION COMPLETE</h3>
        </div>
        <div class="card-body">
            <p class="lead mb-3" id="resultMessage" style="color: white; font-weight: 600;"></p>
            
            <div class="mb-4">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-file-earmark-code me-2" style="color: rgba(255, 255, 255, 0.7);"></i>
                    <span style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Filename:</span>
                </div>
                <code id="resultFileName" style="font-size: 0.9rem; background: rgba(255, 255, 255, 0.1); color: #a8dadc; padding: 0.5rem 1rem; border-radius: 6px; display: inline-block;"></code>
            </div>
            
            <div class="d-grid gap-2 d-md-flex">
                <button type="button" class="btn btn-primary btn-lg" onclick="downloadMarkdown()">
                    <i class="bi bi-download me-2"></i>
                    DOWNLOAD .MD FILE
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetAll()" style="background: rgba(255, 255, 255, 0.1); color: white; border-color: rgba(255, 255, 255, 0.3);">
                    <i class="bi bi-plus-circle me-1"></i>
                    NEW GENERATION
                </button>
            </div>
            
            <div class="alert alert-info mt-4 mb-0" style="background: rgba(138, 180, 248, 0.15); border-color: var(--accent-color); color: var(--accent-color);">
                <i class="bi bi-lightbulb-fill me-2"></i>
                <strong>TIP:</strong> Click download button to choose save location and customize filename
            </div>
        </div>
    </div>
</div>

<style>
    /* 移除不需要的 Markdown 樣式，保留基本樣式 */
</style>

<script>
    // LocalStorage 鍵名
    const STORAGE_KEY = 'sqlServerConnectionInfo';
    let currentConnectionInfo = null;
    let currentMarkdownContent = '';
    let currentFileName = '';

    // 頁面載入時恢復連線資訊
    document.addEventListener('DOMContentLoaded', function() {
        loadConnectionInfo();
        toggleAuthFields();
    });

    // 顯示訊息
    function showMessage(message, type) {
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        
        messageBox.className = `alert alert-${type} alert-dismissible fade show`;
        messageText.textContent = message;
        messageBox.classList.remove('d-none');
        
        // 5秒後自動隱藏
        setTimeout(() => hideMessage(), 5000);
    }

    // 隱藏訊息
    function hideMessage() {
        document.getElementById('messageBox').classList.add('d-none');
    }

    // 收合連線表單
    function collapseConnectionForm() {
        document.getElementById('connectionForm').classList.add('d-none');
        document.getElementById('connectionSummary').classList.remove('d-none');
        
        // 顯示連線資訊
        const authType = document.getElementById('authTypeSelect').value;
        document.getElementById('connectedServer').textContent = document.getElementById('serverName').value;
        document.getElementById('connectedAuth').textContent = `(${authType === 'Windows' ? 'Windows Auth' : 'SQL Auth'})`;
    }

    // 顯示連線表單
    function showConnectionForm() {
        document.getElementById('connectionForm').classList.remove('d-none');
        document.getElementById('connectionSummary').classList.add('d-none');
        
        // 重置其他區域
        document.getElementById('databaseSelect').value = '';
        document.getElementById('databaseSelect').disabled = true;
        document.getElementById('tablesContainer').innerHTML = '<p class="text-muted">請先選擇資料庫</p>';
        document.getElementById('btnGenerate').disabled = true;
        document.getElementById('resultCard').classList.add('d-none');
    }

    // 測試連線
    async function testConnection() {
        const btn = document.getElementById('btnTestConnection');
        const spinner = document.getElementById('spinnerTest');
        
        // 收集連線資訊
        currentConnectionInfo = {
            serverName: document.getElementById('serverName').value.trim(),
            authType: document.getElementById('authTypeSelect').value,
            username: document.getElementById('username').value.trim(),
            password: document.getElementById('password').value,
            trustServerCertificate: document.getElementById('trustCertificate').checked
        };

        // 驗證必填欄位
        if (!currentConnectionInfo.serverName) {
            showMessage('⚠️ Server name is required', 'danger');
            return;
        }

        if (currentConnectionInfo.authType === 'SA' && !currentConnectionInfo.username) {
            showMessage('⚠️ Username is required for SQL Authentication', 'danger');
            return;
        }

        // 顯示載入狀態
        btn.disabled = true;
        spinner.classList.remove('d-none');

        try {
            const response = await fetch('?handler=TestConnection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify(currentConnectionInfo)
            });

            const result = await response.json();

            if (result.success) {
                showMessage('✓ Connection successful!', 'success');
                
                // 填充資料庫列表
                const dbSelect = document.getElementById('databaseSelect');
                dbSelect.innerHTML = '<option value="">-- Select a database --</option>';
                
                if (result.databases && result.databases.length > 0) {
                    result.databases.forEach(db => {
                        const option = document.createElement('option');
                        option.value = db;
                        option.textContent = db;
                        dbSelect.appendChild(option);
                    });
                    dbSelect.disabled = false;
                    
                    // 收合連線表單
                    collapseConnectionForm();
                } else {
                    showMessage('⚠️ No accessible databases found. Check permissions.', 'warning');
                }

                // 儲存連線資訊
                saveConnectionInfo();
            } else {
                showMessage('✗ ' + result.message, 'danger');
            }
        } catch (error) {
            showMessage('✗ Connection failed: ' + error.message, 'danger');
            console.error('Error:', error);
        } finally {
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    // 載入資料表
    async function loadTables() {
        const databaseName = document.getElementById('databaseSelect').value;
        
        if (!databaseName) {
            document.getElementById('tablesContainer').innerHTML = '<p class="text-muted"><i class="bi bi-info-circle me-1"></i>Select a database to load tables</p>';
            document.getElementById('btnGenerate').disabled = true;
            return;
        }

        try {
            const requestData = {
                ...currentConnectionInfo,
                databaseName: databaseName
            };

            const response = await fetch('?handler=GetTables', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (result.success) {
                showMessage(`✓ Loaded ${result.tables.length} tables`, 'success');
                displayTables(result.tables);
                document.getElementById('btnGenerate').disabled = false;
            } else {
                showMessage('✗ ' + result.message, 'danger');
            }
        } catch (error) {
            showMessage('✗ Failed to load tables: ' + error.message, 'danger');
            console.error('Error:', error);
        }
    }

    // 顯示資料表列表
    function displayTables(tables) {
        const container = document.getElementById('tablesContainer');
        
        if (!tables || tables.length === 0) {
            container.innerHTML = '<p class="text-muted"><i class="bi bi-inbox me-1"></i>No tables found in this database</p>';
            return;
        }

        container.innerHTML = '';
        tables.forEach(table => {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-2';
            
            const checkDiv = document.createElement('div');
            checkDiv.className = 'form-check';
            
            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input table-checkbox';
            checkbox.type = 'checkbox';
            checkbox.value = table.fullName;
            checkbox.id = `table_${table.fullName.replace(/\./g, '_')}`;
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = checkbox.id;
            label.innerHTML = `<i class="bi bi-table me-1"></i>${table.fullName}`;
            
            checkDiv.appendChild(checkbox);
            checkDiv.appendChild(label);
            col.appendChild(checkDiv);
            container.appendChild(col);
        });
    }

    // 產生 DD 文件
    async function generateDD() {
        const btn = document.getElementById('btnGenerate');
        const spinner = document.getElementById('spinnerGenerate');
        
        // 收集選中的資料表
        const selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked'))
            .map(cb => cb.value);

        if (selectedTables.length === 0) {
            showMessage('⚠️ Please select at least one table', 'danger');
            return;
        }

        const requestData = {
            ...currentConnectionInfo,
            databaseName: document.getElementById('databaseSelect').value,
            selectedTables: selectedTables
        };

        btn.disabled = true;
        spinner.classList.remove('d-none');

        try {
            const response = await fetch('?handler=Generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (result.success) {
                showMessage('✓ ' + result.message, 'success');
                
                // 儲存 markdown 內容和檔名供下載使用
                currentMarkdownContent = result.markdown;
                currentFileName = result.fileName;
                
                // 顯示結果
                document.getElementById('resultMessage').textContent = result.message;
                document.getElementById('resultFileName').textContent = result.fileName;
                
                document.getElementById('resultCard').classList.remove('d-none');
                
                // 滾動到結果區
                document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
            } else {
                showMessage('✗ ' + result.message, 'danger');
            }
        } catch (error) {
            showMessage('✗ Generation failed: ' + error.message, 'danger');
            console.error('Error:', error);
        } finally {
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    // 下載 Markdown 檔案（讓使用者選擇儲存位置）
    function downloadMarkdown() {
        const blob = new Blob([currentMarkdownContent], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = currentFileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // 清理
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        showMessage('⬇ Downloading file, choose your save location...', 'success');
    }

    // 全選資料表
    function selectAllTables() {
        document.querySelectorAll('.table-checkbox').forEach(cb => cb.checked = true);
    }

    // 取消全選
    function deselectAllTables() {
        document.querySelectorAll('.table-checkbox').forEach(cb => cb.checked = false);
    }

    // 重新開始
    function resetAll() {
        showConnectionForm();
        hideMessage();
        
        // 滾動到頂部
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 儲存連線資訊到 LocalStorage
    function saveConnectionInfo() {
        const rememberCheckbox = document.getElementById('rememberConnection');
        
        if (rememberCheckbox && rememberCheckbox.checked) {
            const connectionInfo = {
                serverName: document.getElementById('serverName').value,
                authType: document.getElementById('authTypeSelect').value,
                username: document.getElementById('username').value,
                trustCertificate: document.getElementById('trustCertificate').checked
            };
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(connectionInfo));
        } else {
            localStorage.removeItem(STORAGE_KEY);
        }
    }

    // 從 LocalStorage 載入連線資訊
    function loadConnectionInfo() {
        const savedInfo = localStorage.getItem(STORAGE_KEY);
        
        if (savedInfo) {
            try {
                const connectionInfo = JSON.parse(savedInfo);
                
                if (connectionInfo.serverName) {
                    document.getElementById('serverName').value = connectionInfo.serverName;
                }
                
                if (connectionInfo.authType) {
                    document.getElementById('authTypeSelect').value = connectionInfo.authType;
                }
                
                if (connectionInfo.username) {
                    document.getElementById('username').value = connectionInfo.username;
                }
                
                if (connectionInfo.trustCertificate !== undefined) {
                    document.getElementById('trustCertificate').checked = connectionInfo.trustCertificate;
                }
                
                toggleAuthFields();
            } catch (e) {
                console.error('載入連線資訊失敗:', e);
            }
        }
    }

    // 清除連線資訊
    function clearConnectionInfo() {
        if (confirm('Clear all saved connection settings?')) {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('serverName').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('authTypeSelect').value = 'Windows';
            document.getElementById('trustCertificate').checked = true;
            toggleAuthFields();
            showMessage('✓ Connection memory cleared', 'success');
        }
    }

    // 切換驗證方式
    function toggleAuthFields() {
        const authType = document.getElementById('authTypeSelect').value;
        const sqlAuthFields = document.getElementById('sqlAuthFields');
        
        if (authType === 'SA') {
            sqlAuthFields.style.display = 'block';
        } else {
            sqlAuthFields.style.display = 'none';
        }
    }
</script>

@* 添加 CSRF Token 支援 *@
@Html.AntiForgeryToken()
