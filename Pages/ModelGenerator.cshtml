@page
@model ModelGeneratorModel
@{
    ViewData["Title"] = "Model Class Generator";
}

<div class="container mt-4">
    <!-- Toast Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;"></div>

    <!-- No Connection Alert -->
    <div class="alert alert-warning d-none" id="noConnectionAlert">
        <h4><i class="bi bi-exclamation-triangle-fill me-2"></i>No Database Connection</h4>
        <p class="mb-0">Please go to <a href="/" class="alert-link">Home Page</a> to set up database connection first.</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="d-none">
        <h1 class="display-5 mb-4">
            <i class="bi bi-file-earmark-code-fill me-3"></i>
            MODEL CLASS GENERATOR
        </h1>

        <!-- Step 1: Configure -->
        <div class="card mb-3">
            <div class="card-header">
                <h3><i class="bi bi-gear-fill me-2"></i>STEP 1: CONFIGURE</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="bi bi-database me-1"></i>Database
                        </label>
                        <select class="form-select" id="databaseSelect" onchange="loadTables()">
                            <option value="">-- Select a database --</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="bi bi-code-square me-1"></i>Namespace
                        </label>
                        <input type="text" class="form-control" id="namespaceInput" 
                               placeholder="e.g., MyProject.Models" 
                               value="MyProject.Models">
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Select Tables -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-table me-2"></i>STEP 2: SELECT TABLES</h3>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTables()">
                        <i class="bi bi-check-all me-1"></i>SELECT ALL
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAllTables()">
                        <i class="bi bi-x-lg me-1"></i>DESELECT ALL
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Search Box -->
                <div class="mb-3">
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text" style="background: rgba(30, 33, 57, 0.6); border-color: var(--border-color);">
                            <i class="bi bi-search" style="color: var(--text-secondary);"></i>
                        </span>
                        <input type="text" 
                               class="form-control form-control-sm" 
                               id="tableSearchInput" 
                               placeholder="Search tables..." 
                               onkeyup="filterTables()"
                               disabled
                               style="background: rgba(30, 33, 57, 0.4); border-color: var(--border-color); color: var(--text-primary);">
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="clearSearch()" style="border-color: var(--border-color);">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <span id="filteredCount">0</span> / <span id="totalCount">0</span> tables
                            <span id="selectedCount" class="ms-2"></span>
                        </small>
                        <small id="searchHint" class="text-muted"></small>
                    </div>
                </div>

                <div id="tablesContainer" class="row">
                    <p class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Select a database to load tables
                    </p>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-success" id="btnGenerate" onclick="generateModels()" disabled>
                        <span class="spinner-border spinner-border-sm d-none me-2" id="spinnerGenerate"></span>
                        <i class="bi bi-file-earmark-zip me-1"></i>
                        GENERATE MODEL CLASSES
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="resetAll()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>
                        RESET
                    </button>
                </div>
            </div>
        </div>

        <!-- Result -->
        <div class="card mb-4 d-none" id="resultCard">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3><i class="bi bi-check-circle-fill me-2"></i>GENERATION COMPLETE</h3>
            </div>
            <div class="card-body">
                <p class="lead mb-3" id="resultMessage" style="color: white; font-weight: 600;"></p>
                
                <div class="mb-4">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-file-earmark-zip me-2" style="color: rgba(255, 255, 255, 0.7);"></i>
                        <span style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Filename:</span>
                    </div>
                    <input type="text" class="form-control" id="resultFileName" 
                           style="background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3); color: #a8dadc; font-family: monospace;">
                </div>
                
                <div class="d-grid gap-2 d-md-flex">
                    <button type="button" class="btn btn-primary btn-lg" onclick="downloadZip()">
                        <i class="bi bi-download me-2"></i>
                        DOWNLOAD ZIP FILE
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="resetAll()" style="background: rgba(255, 255, 255, 0.1); color: white; border-color: rgba(255, 255, 255, 0.3);">
                        <i class="bi bi-plus-circle me-1"></i>
                        NEW GENERATION
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Toast Notification Styles */
    .toast-notification {
        background: linear-gradient(135deg, rgba(30, 33, 57, 0.98), rgba(42, 46, 75, 0.98));
        backdrop-filter: blur(20px);
        border-radius: 10px;
        padding: 0.65rem 1rem;
        margin-bottom: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 320px;
        min-width: 240px;
        position: relative;
        overflow: hidden;
        will-change: transform, opacity;
        transform: translateZ(0);
    }

    .toast-notification::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, var(--toast-color), transparent);
    }

    .toast-notification.success { --toast-color: #81c995; }
    .toast-notification.danger { --toast-color: #f48771; }
    .toast-notification.warning { --toast-color: #ffd166; }
    .toast-notification.info { --toast-color: var(--accent-color); }

    .toast-content {
        display: flex;
        align-items: center;
        flex: 1;
        color: #e8eaed;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
        font-weight: 500;
    }

    .toast-icon {
        margin-right: 8px;
        font-size: 0.95rem;
        color: var(--toast-color);
        filter: drop-shadow(0 0 4px var(--toast-color));
    }

    .toast-close {
        background: rgba(255, 255, 255, 0.05);
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 1rem;
        cursor: pointer;
        padding: 2px 6px;
        margin-left: 0.75rem;
        transition: all 0.2s;
        border-radius: 4px;
        line-height: 1;
    }

    .toast-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    @@keyframes slideInRight {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @@keyframes fadeOut {
        to { opacity: 0; transform: translateX(400px); }
    }

    .toast-notification.hiding {
        animation: fadeOut 0.3s ease-out forwards;
    }
</style>

<script>
    let currentZipData = null;
    let currentFileName = '';

    document.addEventListener('DOMContentLoaded', async function() {
        await checkConnectionAndLoadDatabases();
    });

    async function checkConnectionAndLoadDatabases() {
        try {
            const response = await fetch('?handler=GetDatabases', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });

            const result = await response.json();

            if (result.success && result.databases && result.databases.length > 0) {
                document.getElementById('noConnectionAlert').classList.add('d-none');
                document.getElementById('mainContent').classList.remove('d-none');
                
                const dbSelect = document.getElementById('databaseSelect');
                dbSelect.innerHTML = '<option value="">-- Select a database --</option>';
                result.databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db;
                    option.textContent = db;
                    dbSelect.appendChild(option);
                });
            } else {
                document.getElementById('noConnectionAlert').classList.remove('d-none');
                document.getElementById('mainContent').classList.add('d-none');
            }
        } catch (error) {
            document.getElementById('noConnectionAlert').classList.remove('d-none');
            document.getElementById('mainContent').classList.add('d-none');
        }
    }

    function showMessage(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        
        const icons = {
            success: 'bi-check-circle-fill',
            danger: 'bi-x-circle-fill',
            warning: 'bi-exclamation-triangle-fill',
            info: 'bi-info-circle-fill'
        };
        
        toast.innerHTML = `
            <div class="toast-content">
                <i class="bi ${icons[type]} toast-icon"></i>
                <span>${message}</span>
            </div>
            <button class="toast-close" onclick="closeToast(this)">×</button>
        `;
        
        container.appendChild(toast);
        setTimeout(() => closeToast(toast.querySelector('.toast-close')), 5000);
    }

    function closeToast(button) {
        const toast = button.parentElement;
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }

    async function loadTables() {
        const databaseName = document.getElementById('databaseSelect').value;
        
        if (!databaseName) {
            document.getElementById('tablesContainer').innerHTML = '<p class="text-muted"><i class="bi bi-info-circle me-1"></i>Select a database to load tables</p>';
            document.getElementById('btnGenerate').disabled = true;
            return;
        }

        try {
            const response = await fetch('?handler=GetTables', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ databaseName: databaseName })
            });

            const result = await response.json();

            if (result.success) {
                showMessage(`✓ Loaded ${result.tables.length} tables`, 'success');
                displayTables(result.tables);
                document.getElementById('btnGenerate').disabled = false;
            } else {
                showMessage('✗ ' + result.message, 'danger');
            }
        } catch (error) {
            showMessage('✗ Failed to load tables: ' + error.message, 'danger');
        }
    }

    function displayTables(tables) {
        const container = document.getElementById('tablesContainer');
        const searchInput = document.getElementById('tableSearchInput');
        
        if (!tables || tables.length === 0) {
            container.innerHTML = '<p class="text-muted"><i class="bi bi-inbox me-1"></i>No tables found in this database</p>';
            searchInput.disabled = true;
            updateTableCounts(0, 0, 0);
            return;
        }

        searchInput.disabled = false;
        container.innerHTML = '';
        
        tables.forEach(table => {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-2 table-item';
            col.dataset.tableName = table.fullName.toLowerCase();
            
            const checkDiv = document.createElement('div');
            checkDiv.className = 'form-check';
            
            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input table-checkbox';
            checkbox.type = 'checkbox';
            checkbox.value = table.fullName;
            checkbox.id = `table_${table.fullName.replace(/\./g, '_')}`;
            checkbox.addEventListener('change', updateSelectedCount);
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = checkbox.id;
            label.innerHTML = `<i class="bi bi-table me-1"></i>${table.fullName}`;
            
            checkDiv.appendChild(checkbox);
            checkDiv.appendChild(label);
            col.appendChild(checkDiv);
            container.appendChild(col);
        });
        
        updateTableCounts(tables.length, tables.length, 0);
    }

    function filterTables() {
        const searchInput = document.getElementById('tableSearchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        const tableItems = document.querySelectorAll('.table-item');
        
        let visibleCount = 0;
        let selectedCount = 0;
        
        tableItems.forEach(item => {
            const tableName = item.dataset.tableName;
            const checkbox = item.querySelector('.table-checkbox');
            const isMatch = tableName.includes(searchTerm);
            const isChecked = checkbox.checked;
            
            if (isChecked) {
                selectedCount++;
            }
            
            if (!searchTerm || isMatch || isChecked) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        updateTableCounts(tableItems.length, visibleCount, selectedCount);
        
        const searchHint = document.getElementById('searchHint');
        if (searchTerm && visibleCount === 0) {
            searchHint.textContent = 'No matches';
            searchHint.style.color = 'var(--danger-color)';
        } else if (searchTerm) {
            searchHint.innerHTML = `<i class="bi bi-funnel me-1"></i>"${searchInput.value}"`;
            searchHint.style.color = 'var(--accent-color)';
        } else {
            searchHint.textContent = '';
        }
    }

    function updateTableCounts(total, visible, selected) {
        document.getElementById('totalCount').textContent = total;
        document.getElementById('filteredCount').textContent = visible;
        
        const selectedCountEl = document.getElementById('selectedCount');
        if (selected > 0) {
            selectedCountEl.innerHTML = `<span class="badge bg-primary">${selected} selected</span>`;
        } else {
            selectedCountEl.textContent = '';
        }
    }

    function updateSelectedCount() {
        filterTables();
    }

    function clearSearch() {
        document.getElementById('tableSearchInput').value = '';
        filterTables();
    }

    async function generateModels() {
        const btn = document.getElementById('btnGenerate');
        const spinner = document.getElementById('spinnerGenerate');
        
        const selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked'))
            .map(cb => cb.value);

        const namespace = document.getElementById('namespaceInput').value.trim();

        if (selectedTables.length === 0) {
            showMessage('⚠️ Please select at least one table', 'danger');
            return;
        }

        if (!namespace) {
            showMessage('⚠️ Please enter a namespace', 'danger');
            return;
        }

        const requestData = {
            databaseName: document.getElementById('databaseSelect').value,
            selectedTables: selectedTables,
            namespace: namespace
        };

        btn.disabled = true;
        spinner.classList.remove('d-none');

        try {
            const response = await fetch('?handler=Generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (result.success) {
                showMessage('✓ ' + result.message, 'success');
                
                currentZipData = result.zipData;
                currentFileName = result.fileName;
                
                document.getElementById('resultMessage').textContent = result.message;
                document.getElementById('resultFileName').value = result.fileName;
                document.getElementById('resultCard').classList.remove('d-none');
                document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
            } else {
                showMessage('✗ ' + result.message, 'danger');
            }
        } catch (error) {
            showMessage('✗ Generation failed: ' + error.message, 'danger');
        } finally {
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    function downloadZip() {
        const fileName = document.getElementById('resultFileName').value || currentFileName;
        const byteCharacters = atob(currentZipData);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/zip' });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        showMessage('⬇ Downloading ZIP file...', 'success');
    }

    function selectAllTables() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.table-item:not([style*="display: none"]) .table-checkbox'));
        visibleCheckboxes.forEach(cb => cb.checked = true);
        updateSelectedCount();
    }

    function deselectAllTables() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.table-item:not([style*="display: none"]) .table-checkbox'));
        visibleCheckboxes.forEach(cb => cb.checked = false);
        updateSelectedCount();
    }

    function resetAll() {
        document.getElementById('databaseSelect').value = '';
        document.getElementById('namespaceInput').value = 'MyProject.Models';
        document.getElementById('tableSearchInput').value = '';
        document.getElementById('tableSearchInput').disabled = true;
        document.getElementById('tablesContainer').innerHTML = '<p class="text-muted"><i class="bi bi-info-circle me-1"></i>Select a database to load tables</p>';
        document.getElementById('btnGenerate').disabled = true;
        document.getElementById('resultCard').classList.add('d-none');
        updateTableCounts(0, 0, 0);
        document.getElementById('searchHint').textContent = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>

@Html.AntiForgeryToken()
